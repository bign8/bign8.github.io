<!doctype html>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title></title>
	<meta name="description" content="Awesome!!!">
	<meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
	Link: <span id="url">Loading...</span><br/>
	Title: <span id="title"></span><br/>
	Desc: <span id="desc"></span><br/>
	Img: <span id="img"></span>

<script type="text/javascript">

var N8 = N8 || {}; // Global namespace

N8.links = [
	"http://bign8.info/",
	"http://dbv.vizuina.com/",
	"https://github.com/facebook/facebook-php-sdk",
	"https://developers.facebook.com/docs/graph-api/real-time-updates/#yourcallbackserver",
	"http://www.pi-supply.com/pi-supply-switch-v1-1-code-examples/",
	"http://www.mausberrycircuits.com/pages/setup",
	"http://playground.arduino.cc/Code/AvoidDelay",
	"http://arduino.cc/en/Tutorial/BlinkWithoutDelay",
	"http://jflasher.github.io/spark-helper/",
	"http://net.tutsplus.com/tutorials/other/building-static-sites-with-jekyll/",
	"http://hadihariri.com/2013/12/24/migrating-from-wordpress-to-jekyll/",
	"http://www.kix.in/2013/06/24/jumping-on-the-jekyll-bandwagon/",
	"http://stackoverflow.com/questions/4305955/can-jekyll-act-over-css-or-js-files",
	"http://bign8.disqus.com/",
];

// Custom Bace Convert
N8.bc = (function () {

	var alphalbet = [ // JS (function name) and URL safe please!!!
		'0','1','2','3','4','5','6','7','8','9',
		'a','b','c','d','e','f','g','h','i','j','k','l','m','n','o','p','q','r','s','t','u','v','w','x','y','z',
		'A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y','Z',
	];
	var MAX = alphalbet.length;
	var parseInt2 = function(string, radix) {
		var number = 0;
		for (var i = 0, length = string.length - 1; i < string.length; i++)  
			number += alphalbet.indexOf(string[length - i]) * Math.pow(radix, i);
		return number;
	};
	var toString2 = function(integer, radix) {
		var out = '';
		while (integer >= radix) {
			out = alphalbet[integer % radix] + out;
			integer = Math.floor(integer / radix);
		};
		return alphalbet[integer] + out;
	};
	var convert = function (number, frombase, tobase) {
		// return parseInt(number + '', frombase | 0).toString(tobase | 0); // max radix = 36
		return toString2(parseInt2(number + '', frombase | 0), tobase | 0);
	}

	return {
		convert: convert,
		MAX: MAX,
	};
})();

// JSONP helper
N8.jsonp = (function (bc) {
	if (!bc) throw "Missing N8.bc Library";

	var count = 0;
	var callbacks = {};

	var get = function(url, cb) {
		if (cb) {
			var key = 'cb_' + bc.convert( count++, 10, bc.MAX );
			callbacks[key] = function (data) {
				delete callbacks[key]; // cleanup
				cb(data);
			};
			url = url.replace('CALLBACK', 'N8.jsonp.cb.' + key);
		}

		var script = document.createElement('script');
		script.src = url;
		script.type = 'text/javascript';
		script.async = true;
		script.onload = script.remove;
		document.getElementsByTagName('body')[0].appendChild(script);
	};

	return {
		cb: callbacks,
		get: get,
	};
})(N8.bc); // manual dependency injection

// URL shortener
N8.url = (function (links, bc, jsonp) {
	var lookup = function (key) {
		var index = bc.convert( key, bc.MAX, 10 );
		if (index >= links.length || index < 0) throw "Key out of range";
		return new Promise( gather_meta.bind(undefined, index) );
	};

	var gather_meta = function (index, resolve) {
		var link = links[ index ];
		jsonp.get( 'http://anyorigin.com/get/?url=' + encodeURIComponent(link) + '&callback=CALLBACK', function (data) {
			var obj = parse_dom(data);
			obj.link = link;
			obj.img = 'http://api.webthumbnail.org?width=300&screen=1280&format=png&url=' + encodeURIComponent(link);
			resolve(obj);
		});
	};

	var parse_dom = function (data) {
		var result = {};
		var titles = /<title>([^<]*)<\/title>/gi.exec(data.contents);
		if (titles) result.title = titles[1];

		var descs = /meta content="([^"]*)" name="description"/gi.exec(data.contents);
			descs = descs || /meta name="description" content="([^"]*)"/gi.exec(data.contents);
		if (descs) result.desc = descs[1];
		return result;
	};

	return lookup;
})(N8.links, N8.bc, N8.jsonp); // manual dependency injection

window.onload = function () {
	var hash = document.location.pathname.substr(1);
	try {
		// Generate page html
		if (hash.length > 0) N8.url(hash).then(function (res) {
			document.getElementById('url').innerHTML = '<a href="' + res.link + '" target="_blank">' + res.link + '</a>';
			document.getElementById('img').innerHTML = '<img src="' + res.img + '">';
			if (res.title) document.getElementById('title').innerHTML = res.title;
			if (res.desc) document.getElementById('desc').innerHTML = res.desc;
		});
	} catch (e) {
		console.log('catched');
		setTimeout(function () {
			document.location = '/real-404.html';
		}, 5000);
	}
};
</script>

</body>
</html>
